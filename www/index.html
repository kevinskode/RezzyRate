<!--TEST 1-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rezzy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f8fb; --panel:#ffffff; --text:#0f172a; --muted:#475569;
      --border:#e5e7eb; --accent:#4f46e5; --radius:14px; --shadow:0 4px 16px rgba(2,6,23,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#9aa4b2; --border:rgba(148,163,184,.18); --shadow:0 6px 20px rgba(2,6,23,.35); }
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:100%; /* avoid iOS auto-zoom */
    }
    .container{max-width:1100px; margin:0 auto; padding:20px clamp(16px,3vw,24px)}
    /* iPhone safe areas */
    @supports(padding:max(0px)){
      .container{
        padding-left:max(16px, env(safe-area-inset-left));
        padding-right:max(16px, env(safe-area-inset-right));
      }
    }

    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}

    /* Logo image */
    .logo{
      width:clamp(32px,4vw,55px);
      height:clamp(32px,4vw,55px);
      border-radius:12px;
      object-fit:cover;
      display:block;
      box-shadow:0 2px 10px rgba(79,70,229,.25);
      border:1px solid var(--border);
      background:transparent;
    }

    /* --- Buy scan buttons: neon green --- */
    #btnBuy1Top, #btnBuy10Top, #btnBuy20Top,
    #btnBuy1Modal, #btnBuy10Modal, #btnBuy20Modal{
      background:#19ff0099;          /* requested color */
      border-color:#19ff0099;
      color:#ffffff;                  /* readable text on green */
      box-shadow:none;
    }
    #btnBuy1Top:hover, #btnBuy10Top:hover, #btnBuy20Top:hover,
    #btnBuy1Modal:hover, #btnBuy10Modal:hover, #btnBuy20Modal:hover{
      filter:brightness(1.06);
    }

    h1{margin:0;font-size:clamp(18px,2.4vw,22px);font-weight:700}
    .helper{font-size:12px;color:var(--muted)}
    .badges{display:flex;gap:8px;align-items:center}
    .badge{font-size:12px;padding:6px 10px;border-radius:9999px;background:var(--panel);border:1px solid var(--border);color:var(--muted)}

    .layout{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:980px){.layout{grid-template-columns:1fr 1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .card-title{font-size:16px;font-weight:700;margin:2px 0}
    .card-sub{font-size:13px;color:var(--muted);margin:0 0 10px}
    label{font-size:13px;color:#96d1f8;font-weight:900;letter-spacing:.06em;text-transform:uppercase;display:block;margin:8px 0 6px}

    /* Prevent iOS zoom on focus with >=16px text */
    textarea,input{
      width:100%;background:#f8fafc;color:#0f172a;border:1px solid var(--border);
      border-radius:12px;padding:12px 14px;transition:box-shadow .2s,border-color .2s;
      font-size:12px; line-height:1.4;
    }
    textarea:focus,input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,70,229,.18)}
    @media(prefers-color-scheme:dark){textarea,input{background:#0b1220;color:var(--text)}}
    textarea{min-height:140px;resize:vertical}

    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .actions .spacer{flex:1 1 auto}

    button{
      padding:10px 14px;border-radius:12px;border:1px solid transparent;background:var(--panel);
      color:var(--text);cursor:pointer;font-weight:600;transition:transform .1s ease, box-shadow .2s, border-color .2s;
      min-height:44px; /* good tap target */
    }
    button:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg,#4f46e5,#4338ca);color:#fff;border-color:#4f46e5;box-shadow:0 6px 16px rgba(79,70,229,.20)}
    .btn-primary:hover{box-shadow:0 8px 22px rgba(79,70,229,.28)}
    .btn-secondary{background:var(--panel);border-color:var(--border);color:var(--text)}
    .btn-compact{padding:8px 12px;border-radius:10px}
    .pricing-buttons{display:flex;gap:8px;align-items:center}
    @media(max-width:700px){ .pricing-buttons{width:100%;justify-content:flex-start;flex-wrap:wrap} }

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9999px;font-size:12px;margin:2px;border:1px solid var(--border);color:var(--muted);white-space:nowrap}
    .pill.good{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    @media(prefers-color-scheme:dark){
      .pill.good{background:#0d2621;color:#86efac;border-color:rgba(52,211,153,.25)}
      .pill.bad{background:#2a1517;color:#fca5a5;border-color:rgba(251,113,133,.25)}
    }

    /* Priority pills — blue scale by urgency (NEW) */
    .pill.p-high{  /* Quick win (strongest blue) */
      background:#1788c1; border-color:#93c5fd; color:#153ab0;
    }
    .pill.p-med{   /* Worth doing (medium blue) */
      background:#5b93b1; border-color:#a5b4fc; color:#6e68c1;
    }
    .pill.p-low{   /* Nice to have (lightest blue) */
      background:#8ba4af; border-color:#c7d2fe; color:#e5aacc;
    }
    @media (prefers-color-scheme: dark){
      .pill.p-high{ background:rgba(37,99,235,.24);  border-color:rgba(59,130,246,.45);  color:#dbeafe; }
      .pill.p-med{  background:rgba(99,102,241,.22); border-color:rgba(129,140,248,.38); color:#e0e7ff; }
      .pill.p-low{  background:rgba(99,102,241,.14); border-color:rgba(129,140,248,.28); color:#c7d2fe; }
    }

    .progress{height:8px;border-radius:9999px;background:#f1f5f9;border:1px solid var(--border);overflow:hidden}
    @media(prefers-color-scheme:dark){.progress{background:#0b1220}}
    .progress-bar{height:100%;border-radius:9999px;background:linear-gradient(90deg,#818cf8,#4f46e5);width:0;transition:width .8s cubic-bezier(.2,.7,.2,1)}

    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.open{display:flex}
    .modal{max-width:560px;width:100%}

    .results-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .score-block{display:flex;align-items:center;gap:12px}
    .donut{width:64px;height:64px;display:grid;place-items:center;position:relative}
    .donut .center{position:absolute;font-weight:800;font-size:16px;color:var(--text)}
    .rating{font-size:12px;color:var(--muted)}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    .kpi{padding:10px;border:1px solid var(--border);border-radius:12px}
    .kpi b{color:var(--text)}
    .bar{height:8px;border-radius:9999px;background:#f1f5f9;border:1px solid var(--border);overflow:hidden}
    @media(prefers-color-scheme:dark){.bar{background:#0b1220}}
    .bar-fill{height:100%;width:0;background:linear-gradient(90deg,#818cf8,#4f46e5)}
    .stack{display:flex;height:10px;border-radius:9999px;overflow:hidden;border:1px solid var(--border)}
    .stack > div{height:100%}
    .stack .ok{background:#10b98122}
    .stack .gap{background:#ef444422}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .metric{padding:8px 10px;border:1px dashed var(--border);border-radius:10px;font-size:12px;color:var(--muted)}
    .metric b{color:var(--text)}
    .section-pills{display:flex;flex-wrap:wrap;gap:6px}

    .tip{position:relative;display:inline-flex;align-items:center;margin-left:6px}
    .tip-btn{width:18px;height:18px;padding:0;border-radius:9999px;border:1px solid var(--border);background:var(--panel);color:var(--muted);font-size:12px;line-height:1;font-weight:700;display:grid;place-items:center;cursor:help;}
    .tip-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(79,70,229,.18);border-color:var(--accent);color:var(--text)}
    .tip-bubble{position:absolute;left:50%;bottom:calc(100% + 10px);transform:translateX(-50%) scale(.98);min-width:220px;max-width:320px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);font-size:12px;color:var(--text);opacity:0;pointer-events:none;transition:opacity .15s ease,transform .15s ease;z-index:60}
    .tip:hover .tip-bubble,.tip:focus-within .tip-bubble{opacity:1;transform:translateX(-50%) scale(1);pointer-events:auto}
    .tip-bubble .arrow{position:absolute;left:50%;bottom:-6px;width:10px;height:10px;transform:translateX(-50%) rotate(45deg);background:var(--panel);border-left:1px solid var(--border);border-top:1px solid var(--border)}

    /* Upload UI */
    .upload-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .file-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px dashed var(--border);border-radius:12px;font-size:12px;background:var(--panel)}
    .file-pill input[type="file"]{display:none}
    .file-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);font-size:12px}

    .dropzone{flex:1 1 260px;border:1px dashed var(--border);border-radius:12px;padding:10px;min-height:44px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
    .dropzone.drag{border-color:#60a5fa;background:rgba(99,102,241,.06);color:#4f46e5}
    .spinner{display:none;width:16px;height:16px;border-radius:50%;border:2px solid #c7d2fe;border-top-color:#4f46e5;animation:spin 1s linear infinite}
    .spinner.show{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* --- Top Fixes grid & card content --- */
    .list-tight{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin:0;
      padding:0;
      counter-reset:fix;
    }
    @media (min-width: 900px){ .list-tight{ grid-template-columns:1fr 1fr; } }
    .list-tight li{
      list-style:none; position:relative;
      padding:14px 14px 12px 46px;
      border:1px solid var(--border); border-radius:16px;
      background:rgba(99,102,241,.04); box-shadow:var(--shadow);
    }
    .list-tight li::before{
      counter-increment:fix; content: counter(fix);
      position:absolute; left:12px; top:14px;
      width:22px; height:22px; border-radius:9999px;
      display:grid; place-items:center; font-weight:700; font-size:12px;
      color:var(--muted); background:var(--panel); border:1px solid var(--border);
    }
    .fix-row{display:flex;flex-direction:column;align-items:flex-start;gap:6px;margin-bottom:6px}
    .fix-title{display:block;font-weight:700;font-size:14px;color:var(--text);letter-spacing:.01em;text-wrap:balance;margin:0}
    .fix-body{color:var(--muted);font-size:14px;line-height:1.6;margin:0}
    .list-tight li, .fix-body{word-break:keep-all;overflow-wrap:break-word;hyphens:auto;text-wrap:pretty}
    .list-tight li .pill{margin:0}
    @media (prefers-color-scheme: dark){
      .list-tight li{ background:rgba(99,102,241,.10); }
      .list-tight li::before{ background:var(--panel); color:var(--muted); }
    }

    /* ---- Custom color for Browse + Clear ---- */
    #btnPick, #btnClear{
      background:#a9bae136;
      background:rgba(169,186,225,0.21);
      border-color:#a9bae136;
    }
    #btnPick:hover, #btnClear:hover{ filter:brightness(1.05); }

    /* ---- Buy scan buttons: structured label + price chip ---- */
    .buy-btn{
      background:#19ff0099;
      border-color:#19ff0099;
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:4px 14px;
      border-radius:14px;
      font-weight:700;
      box-shadow:0 8px 18px rgba(25,255,0,.15), inset 0 -2px 0 rgba(0,0,0,.12);
      transition:transform .12s ease, box-shadow .2s ease, filter .15s ease;
    }
    .buy-btn:hover{ transform:translateY(-1px); box-shadow:0 12px 26px rgba(25,255,0,.22), inset 0 -2px 0 rgba(0,0,0,.12); }
    .buy-btn:active{ transform:translateY(0); }
    .buy-btn .btn-label{ font-weight:800; letter-spacing:.01em; }
    .buy-btn .btn-price{
      font-size:12px; font-weight:800; padding:4px 8px; line-height:1;
      border-radius:9999px; background:rgba(255,255,255,.18); color:#fff;
    }
    @media (prefers-color-scheme: dark){
      .buy-btn .btn-price{ background:rgba(255,255,255,.22); }
    }

    /* keep id-based overrides (same color) */
    #btnBuy1Top, #btnBuy10Top, #btnBuy20Top,
    #btnBuy1Modal, #btnBuy10Modal, #btnBuy20Modal{
      background:#19ff0099; border-color:#19ff0099; color:#ffffff; box-shadow:none;
    }
    #btnBuy1Top:hover, #btnBuy10Top:hover, #btnBuy20Top:hover,
    #btnBuy1Modal:hover, #btnBuy10Modal:hover, #btnBuy20Modal:hover{ filter:brightness(1.06); }

    /* ---- Visual status LED (empty by default, solid on success) ---- */
    .statusled{
      width:12px; height:12px; border-radius:9999px;
      background:transparent;                           /* empty */
      border:2px solid rgba(148,163,184,.55);           /* subtle outline */
      box-shadow:none;
      transition:
        background-color .2s ease,
        border-color .2s ease,
        transform .2s ease,
        opacity .2s ease,
        box-shadow .25s ease;
    }
    .statusled.ready{
      background:transparent;
      border-color:rgba(148,163,184,.55);
    }
    .statusled.scanning{
      background:transparent;
      border-color:#60a5fa;
      animation:pulse 1.2s infinite;
      box-shadow:0 0 0 3px rgba(96,165,250,.18);
    }
    .statusled.done{
      background:#10b981;
      border-color:#10b981;
      box-shadow:0 0 0 3px rgba(16,185,129,.26), 0 0 12px rgba(16,185,129,.35);
    }
    .statusled.error{
      background:#ef4444;
      border-color:#ef4444;
      box-shadow:0 0 0 3px rgba(239,68,68,.22), 0 0 12px rgba(239,68,68,.40);
    }
    @keyframes pulse{ 0%{transform:scale(1)} 70%{transform:scale(1.18)} 100%{transform:scale(1)} }

    /* Screen-reader only helper */
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* ======== MOBILE REFINEMENTS ======== */
    /* Topbar wraps: badges drop below brand on phones */
    @media (max-width: 640px){
      .topbar{flex-wrap:wrap; align-items:flex-start; gap:10px}
      .badges{order:2; width:100%; flex-wrap:wrap; justify-content:flex-start}
      .badge{margin-top:4px}
      .helper{font-size:11px}
    }
    /* Hide subtitle on ultra-narrow screens for space */
    @media (max-width: 360px){
      .brand .helper{display:none}
    }
    /* Upload row stacks vertically */
    @media (max-width: 640px){
      .upload-row{flex-direction:column; align-items:stretch}
      .file-pill, .file-btn, .dropzone{width:100%}
    }
    /* Actions layout on small screens */
    @media (max-width: 640px){
      .actions .spacer{display:none}
      .pricing-buttons{width:100%; flex-wrap:wrap}
      .pricing-buttons .buy-btn{flex:1 1 110px; justify-content:center}
      .actions > .btn-primary, .actions > .btn-secondary{flex:1 1 140px}
    }
    /* KPI & metrics grids collapse progressively */
    @media (max-width: 820px){ .kpi-grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 460px){ .kpi-grid{grid-template-columns:1fr} .metrics{grid-template-columns:1fr} }
    /* Smaller donut on phones */
    @media (max-width: 480px){
      .donut{width:56px; height:56px}
      .donut .center{font-size:14px}
      .results-head{align-items:flex-start}
    }
  </style>

  <!-- PDF.js + Mammoth for client-side parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script>window.pdfjsLib && (pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js");</script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js" defer></script>
</head>
<body>
  <div class="container">
    <header class="topbar">
      <div class="brand">
        <img class="logo" src="logo.png" alt="Rezzy logo" />
        <div>
          <h1>Rezzy Rate</h1>
          <div class="helper">The smart resume checker</div>
        </div>
      </div>
      <div class="badges">
        <span class="badge" id="freeBadge">Free credits left today: 1</span>
        <span class="badge" id="creditBadge">Paid credits: 0</span>
      </div>
    </header>

    <main class="layout">
      <section class="card">
        <h2 class="card-title">Check to see if your resume is industry ready</h2>
        <p class="card-sub">Paste your resume and the job description. Or upload a file — we’ll extract the text and score it.</p>

        <!-- Upload row -->
        <div class="upload-row">
          <label class="file-pill" style="cursor:pointer">
            <input id="resumeFile" type="file" accept=".pdf,.docx,.txt,.rtf" />
            <span id="fileLabel">Choose PDF, DOCX, or TXT</span>
          </label>
          <button id="btnPick" class="file-btn" type="button">Browse</button>
          <div id="dropzone" class="dropzone">or drag & drop your resume here</div>

          <!-- Visual status (LED + spinner). The text is sr-only for a11y. -->
          <span class="helper" id="scanStatus" style="display:flex;align-items:center;gap:8px">
            <span class="statusled ready" id="statusLed" aria-hidden="true"></span>
            <span class="spinner" id="scanSpinner" aria-hidden="true"></span>
            <span id="scanText" class="sr-only">Ready</span>
          </span>
        </div>

        <label>Paste Resume Text</label>
        <textarea id="resume" rows="12">JOHN DOE
Detroit, MI • john.doe@email.com • (313) 555-1212

SUMMARY
Data-driven analyst with 5+ years improving KPI visibility and reducing cycle time across finance and operations.

EXPERIENCE
Acme Corp — Senior Analyst (2021–Present)
• Led dashboard rebuild, improving reporting speed by 35%.
• Automated monthly close with Python, saving 12 hours per cycle.
• Partnered with sales to forecast pipeline; reduced variance by 18%.

EDUCATION
B.S. in Information Systems, Michigan State University

SKILLS
SQL, Python, Tableau, Excel, Power BI, Forecasting, ETL</textarea>

        <label>Paste Job Description (optional)</label>
        <textarea id="jd" rows="6">We seek a Business Data Analyst to build SQL pipelines, automate reporting in Python, and create Tableau dashboards. Experience with forecasting, ETL, and stakeholder communication required.</textarea>

        <label>Add more keywords to compare (comma separated)</label>
        <input id="keywords" placeholder="SQL, Python, Tableau, ETL, forecasting" value="SQL, Python, Tableau, ETL, forecasting"/>

        <div class="actions" style="margin-top:6px">
          <button class="btn-primary" onclick="analyze()">Analyze</button>
          <button id="btnClear" class="btn-secondary" onclick="clearAll()">Clear</button>
          <span class="spacer"></span>
          <div class="pricing-buttons">
            <button id="btnBuy1Top"  class="btn-secondary btn-compact buy-btn" onclick="openPaywall(1)"></button>
            <button id="btnBuy10Top" class="btn-secondary btn-compact buy-btn" onclick="openPaywall(10)"></button>
            <button id="btnBuy20Top" class="btn-secondary btn-compact buy-btn" onclick="openPaywall(20)"></button>
          </div>
        </div>
      </section>

      <section id="results" class="card">
        <div style="text-align:center;color:var(--muted)">
          <div style="width:44px;height:44px;border-radius:9999px;margin:8px auto;background:linear-gradient(135deg,#60a5fa,#4f46e5)"></div>
          <h3 style="margin:6px 0 4px;color:var(--text)">Ready to score your resume</h3>
          <div class="helper">Paste your resume or upload a file, then click <b>Analyze</b>.</div>
        </div>
      </section>
    </main>
    <footer style="margin-top:40px;padding:20px 0;border-top:1px solid var(--border);text-align:center;font-size:13px;color:var(--muted)">
      <p style="margin:6px 0">
        <a href="about.html" style="color:var(--accent);text-decoration:none;margin:0 10px">About</a> •
        <a href="privacy.html" style="color:var(--accent);text-decoration:none;margin:0 10px">Privacy Policy</a>
      </p>
      <p style="margin:6px 0">&copy; 2025 Rezzy Rate. All rights reserved.</p>
    </footer>

  </div>

  <div id="paywall" class="overlay" aria-modal="true" role="dialog">
    <div class="card modal">
      <h2 class="card-title" style="margin-top:0">Get more scans</h2>
      <p id="paywallLeadText" class="card-sub" style="margin-bottom:12px">
        You used your free daily scan. Buy additional scans for <strong>$0.49</strong> or save with a pack.
      </p>
      <div class="actions">
        <div class="pricing-buttons">
          <button id="btnBuy1Modal"  class="btn-primary btn-compact buy-btn" onclick="startCheckout(1)"></button>
          <button id="btnBuy10Modal" class="btn-primary btn-compact buy-btn" onclick="startCheckout(10)"></button>
          <button id="btnBuy20Modal" class="btn-primary btn-compact buy-btn" onclick="startCheckout(20)"></button>
        </div>
        <span class="spacer"></span>
        <button class="btn-secondary btn-compact" onclick="closePaywall()">Close</button>
      </div>
      <p class="helper" style="margin-top:12px">Dev mode: This demo adds credits to localStorage. Replace <code>startCheckout</code> with Stripe Checkout + webhook.</p>
    </div>
  </div>

<script>
/* ===== Prices ===== */
const PRICES = { single: 0.49, pack10: 3.99, pack20: 5.99 };
const fmt = n => `$${n.toFixed(2)}`;
function updatePricingUI(){
  const p1 = fmt(PRICES.single), p10 = fmt(PRICES.pack10), p20 = fmt(PRICES.pack20);

  const lead = document.getElementById('paywallLeadText');
  if (lead) lead.innerHTML = `You used your free daily scan. Buy additional scans for <strong>${p1}</strong> or save with a pack.`;

  const setBtn = (id, qty, price) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = `<span class="btn-label">${qty} ${qty===1?'Scan':'Scans'}</span><span class="btn-price">${price}</span>`;
  };

  // Top buttons
  setBtn('btnBuy1Top', 1,  p1);
  setBtn('btnBuy10Top',10, p10);
  setBtn('btnBuy20Top',20, p20);

  // Modal buttons
  setBtn('btnBuy1Modal', 1,  p1);
  setBtn('btnBuy10Modal',10, p10);
  setBtn('btnBuy20Modal',20, p20);
}

/* ===== Metering & Paywall ===== */
const LS_KEYS = { lastDate:'rc_lastDate', dailyUsed:'rc_dailyUsed', credits:'rc_credits', unlimitedUntil:'rc_unlimited_until' };

(function handleUnlimitedFlag(){
  const params = new URLSearchParams(location.search);
  const hours = 48;
  if (params.get('unlimited') === '1'){
    localStorage.setItem(LS_KEYS.unlimitedUntil, String(Date.now() + hours*60*60*1000));
    try{ history.replaceState(null,'',location.pathname); }catch(e){}
  } else if (params.get('unlimited') === '0'){
    localStorage.removeItem(LS_KEYS.unlimitedUntil);
    try{ history.replaceState(null,'',location.pathname); }catch(e){}
  }
})();
function isUnlimited(){ const until = parseInt(localStorage.getItem(LS_KEYS.unlimitedUntil)||'0',10); return Date.now() < until; }
const todayStr = () => { const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); };
function readMeter(){
  const today = todayStr();
  const last = localStorage.getItem(LS_KEYS.lastDate);
  if (last !== today){ localStorage.setItem(LS_KEYS.lastDate, today); localStorage.setItem(LS_KEYS.dailyUsed, '0'); }
  const freeUsed = parseInt(localStorage.getItem(LS_KEYS.dailyUsed)||'0',10);
  const credits = parseInt(localStorage.getItem(LS_KEYS.credits)||'0',10);
  return { freeLeft: Math.max(0, 1 - freeUsed), credits };
}
function writeMeter({freeConsumed=0, creditConsumed=0, creditAdd=0}={}){
  const used = parseInt(localStorage.getItem(LS_KEYS.dailyUsed)||'0',10) + freeConsumed;
  const credits = Math.max(0, parseInt(localStorage.getItem(LS_KEYS.credits)||'0',10) - creditConsumed + creditAdd);
  localStorage.setItem(LS_KEYS.dailyUsed, String(used));
  localStorage.setItem(LS_KEYS.credits, String(credits));
  updateMeterUI();
}
function updateMeterUI(){
  const {freeLeft, credits} = readMeter();
  document.getElementById('creditBadge').textContent = `Paid credits: ${credits}`;
  document.getElementById('freeBadge').textContent = isUnlimited() ? 'Free scans left today: ∞ (temp)' : `Free scans left today: ${freeLeft}`;
}
function canConsumeScan(){
  if (isUnlimited()) return { ok:true, mode:'unlimited' };
  const {freeLeft, credits} = readMeter();
  if (freeLeft > 0) return { ok:true, mode:'free' };
  if (credits > 0) return { ok:true, mode:'credit' };
  return { ok:false, mode:'pay' };
}
function consumeScan(mode){ if (mode==='free') writeMeter({freeConsumed:1}); else if (mode==='credit') writeMeter({creditConsumed:1}); }

/* ===== Heuristic scoring helpers ===== */
const STOPWORDS = new Set(["the","a","an","and","or","but","if","then","else","of","to","in","for","on","at","with","by","from","as","that","this","these","those","is","are","was","were","be","been","being","it","its","your","you","i","me","my","we","our","they","their"]);
const SECTION_HINTS = ["experience","education","skills","projects","certifications","summary","contact","awards"];
const normalize = t => (t||"").replace(/\u2022/g,"-").replace(/[\t\r]/g," ").trim();
const tokenize = t => normalize(t).toLowerCase().replace(/[^a-z0-9%$+\-\s]/g," ").split(/\s+/).filter(Boolean);
const wordFreq = t => { const f=new Map(); for(const w of tokenize(t)){ if(STOPWORDS.has(w)||w.length<3) continue; f.set(w,(f.get(w)||0)+1);} return f; };
const extractKeywords = (t,n=15)=> [...wordFreq(t).entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([w])=>w);
const unique = a => [...new Set(a.filter(Boolean))];
const countNumbers = t => (t.match(/(^|\s)(\$?\d+[\d,]*(\.?\d+)?%?)/g)||[]).length;
function bulletStats(t){ const lines=normalize(t).split(/\n+/); return { bullets:lines.filter(l=>/^\s*[-•*]/.test(l)).length, exclam:(t.match(/!/g)||[]).length, capsWords:(t.match(/\b[A-Z]{4,}\b/g)||[]).length, longLines:lines.filter(l=>l.length>160).length }; }
const passiveVoiceCount = t => (t.match(/\b(?:was|were|is|are|been|being|be)\s+[a-z]+ed\b/gi)||[]).length;
function fleschReadingEase(t){ const s=(t.match(/[.!?]+/g)||["."]).length; const words=tokenize(t); const wc=Math.max(words.length,1); const syl=words.reduce((sum,w)=>sum+ (w.match(/[aeiouy]{1,2}/g)||[]).length,0); const ASL=wc/s; const ASW=syl/wc; return Math.max(0,Math.min(100,Math.round(206.835-1.015*ASL-84.6*ASW))); }
const presenceScore = t => Math.min(15, Math.round((SECTION_HINTS.filter(s=> normalize(t).toLowerCase().includes(s)).length/5)*15));

function keywordScore(resume,keywords){
  const rTokens=new Set(tokenize(resume));
  const list=unique(keywords.map(k=>k.toLowerCase().trim()).filter(k=>k.length>0));
  const present=[]; const missing=[];
  for(const k of list){ (rTokens.has(k)?present:missing).push(k); }
  const coverage=list.length?present.length/list.length:0;
  return { score:Math.round(40*coverage), missing, present, coverage, total:list.length };
}
function professionalismScore(r){
  const {bullets,exclam,capsWords,longLines}=bulletStats(r);
  const pv=passiveVoiceCount(r);
  const words=tokenize(r).length;
  let score=35;
  if(exclam>0)score-=Math.min(5,exclam*2);
  score-=Math.min(5,Math.floor(capsWords/5));
  score-=Math.min(5,Math.floor(pv/4));
  score-=Math.min(5,longLines);
  if(bullets>=5)score+=2;
  if(countNumbers(r)>=3)score+=3;
  if(words>=250&&words<=900)score+=2;
  return {score:Math.max(0,Math.min(35,Math.round(score))), details:{bullets,exclam,capsWords,longLines,passive:pv,words,numbers:countNumbers(r)}};
}
const readabilityScore = r => Math.round((fleschReadingEase(r)/100)*10);

function scoreResume(resume,jd,userKeywords){
  const extracted=extractKeywords(jd||"");
  const combined=unique([...(userKeywords||[]),...extracted]);
  const kw=keywordScore(resume,combined);
  const prof=professionalismScore(resume);
  const pres=presenceScore(resume);
  const read=readabilityScore(resume);
  const total=Math.max(0,Math.min(100,Math.round(kw.score+prof.score+pres+read)));
  return{
    total,
    breakdown:{ats_keywords:kw.score,professionalism:prof.score,structure:pres,readability:read},
    coverage:kw.coverage, missingKeywords:kw.missing, presentKeywords:kw.present, totalKeywords:kw.total,
    extractedKeywords:extracted,
    profDetails:prof.details,
    sectionPresence: SECTION_HINTS.reduce((acc,s)=>{ acc[s]=normalize(resume).toLowerCase().includes(s); return acc; },{})
  };
}

const pct = (val,max)=> Math.round((max?val/max:0)*100);
function classifyScore(total){ if(total>=85) return "Excellent"; if(total>=70) return "Strong"; if(total>=55) return "Fair"; return "Needs work"; }
function gradeReadability(r){ if(r>=8) return "Very easy to skim"; if(r>=6) return "Plain & readable"; if(r>=5) return "Somewhat dense"; if(r>=3) return "Hard to read"; return "Very hard to read"; }

/* ---------- Friendlier, human-sounding recommendations ---------- */
function friendlyFixes(result, fre){
  const tips = [];
  const present=(result.presentKeywords||[]);
  const missing=(result.missingKeywords||[]);
  const totalKW = result.totalKeywords || (present.length + missing.length);
  const perKw = totalKW ? Math.max(1, Math.round(40/totalKW)) : 0;

  /* UPDATED: blue urgency pills */
  const tag = (p) =>
    p === 'high' ? '<span class="pill p-high">Quick win</span>' :
    p === 'med'  ? '<span class="pill p-med">Worth doing</span>' :
                   '<span class="pill p-low">Nice to have</span>';

  const addTip = (priority,title,body) =>
    tips.push(`<li>
      <div class="fix-row">${tag(priority)}<span class="fix-title">${title}</span></div>
      <p class="fix-body">${body}</p>
    </li>`);

  if (missing.length){
    const show = missing.slice(0,10);
    addTip('high','Add a few missing keywords',
      `Sprinkle in terms the job uses — ${show.join(', ')}. Each one should bump your ATS score by about +${perKw}.`);
  }
  if (result.profDetails.numbers < 3){
    addTip('high','Show the impact with numbers',
      `You’ve got ${result.profDetails.numbers}. Aim for 3–5 clear wins like “cut processing time 30%,” “saved $50K,” or “reduced variance 18%.”`);
  }
  const missingSections = Object.entries(result.sectionPresence).filter(([,v])=>!v).map(([k])=>k);
  if (missingSections.length){
    addTip('med','Fill the missing sections',
      `Add ${missingSections.join(', ')} so recruiters (and ATS) can find the essentials fast.`);
  }
  if (!result.sectionPresence.summary){
    addTip('med','Write a short summary',
      `Two–three lines: your title, core skills, and one impact line. Example: “Business Data Analyst • SQL, Python, Tableau • automate reporting and forecast accuracy.”`);
  }
  if (result.profDetails.passive > 3){
    addTip('med','Use active verbs',
      `I spotted ${result.profDetails.passive} passive phrases. Swap “was built/were automated” for “Built,” “Automated,” or “Forecasted.”`);
  }
  if (result.profDetails.bullets < 5){
    addTip('med','Add a few more bullets',
      `You have ${result.profDetails.bullets}. Aim ~5–7 bullets for recent roles and ~3–5 for older ones.`);
  }
  if (result.breakdown.readability <= 5 || fre < 55){
    addTip('med','Smooth the reading flow',
      `Your Flesch score is ${fre}. Keep sentences to ~12–18 words, split long lines into bullets, and swap heavy jargon for plain terms.`);
  }
  if (result.profDetails.longLines > 0){
    addTip('low','Break up long lines',
      `${result.profDetails.longLines} line(s) are quite long. Keep bullets under ~160 characters so they’re easy to scan.`);
  }
  if (result.profDetails.capsWords > 6){
    addTip('low','Dial back ALL CAPS',
      `${result.profDetails.capsWords} ALL-CAPS words found. Bold or positioning usually works better than shouting.`);
  }
  if (result.profDetails.exclam > 0){
    addTip('low','Skip exclamation marks',
      `You don’t need them — the results can carry the energy on their own.`);
  }
  if (result.profDetails.words < 300){
    addTip('low','Add a bit more substance',
      `${result.profDetails.words} words now. A solid one-pager usually lands around 400–700 words.`);
  } else if (result.profDetails.words > 950){
    addTip('low','Tighten the length',
      `${result.profDetails.words} words total. Trim to a page unless you’ve got 10+ years to showcase.`);
  }
  addTip('low','Keep it ATS-friendly',
    `Use a single column with standard headings, avoid text inside images/tables, and export as a text-based PDF.`);
  if (present.length && missing.length){
    addTip('low','Match the job’s phrasing',
      `When it makes sense, mirror the wording (e.g., “data pipelines” vs “pipelines of data”) so scanners don’t miss it.`);
  }

  return tips.slice(0,12);
}

/* Donut SVG */
function donutSVG(percent,label){
  const r=28, c=2*Math.PI*r, off=c*(1-percent/100);
  const gid = `g${Math.random().toString(36).slice(2,7)}`;
  return `
  <svg class="donut" viewBox="0 0 72 72" role="img" aria-label="Score ${percent}%">
    <defs><linearGradient id="${gid}" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#818cf8"/><stop offset="100%" stop-color="#4f46e5"/></linearGradient></defs>
    <circle cx="36" cy="36" r="${r}" fill="none" stroke="rgba(148,163,184,.25)" stroke-width="8"/>
    <circle cx="36" cy="36" r="${r}" fill="none" stroke="url(#${gid})" stroke-width="8" stroke-linecap="round" stroke-dasharray="${c}" stroke-dashoffset="${off}" transform="rotate(-90 36 36)"/>
  </svg>
  <div class="center">${label}</div>`;
}

/* Tooltip builder */
const tipHTML = inner => `
  <span class="tip">
    <button class="tip-btn" type="button" aria-label="More info">i</button>
    <span class="tip-bubble" role="tooltip">${inner}<span class="arrow" aria-hidden="true"></span></span>
  </span>`;

/* ===== UI: analyze() renders the results ===== */
function analyze(){
  const gate = canConsumeScan();
  if (!gate.ok){ openPaywall(); return; }

  const resume=document.getElementById('resume').value;
  const jd=document.getElementById('jd').value;
  const keywords=(document.getElementById('keywords').value||'').split(/,|\n/).map(s=>s.trim()).filter(Boolean);
  const result=scoreResume(resume,jd,keywords);

  consumeScan(gate.mode);

  const present=(result.presentKeywords||[]);
  const missing=(result.missingKeywords||[]);
  const totalKW = present.length + missing.length;
  const covPct = Math.round((result.coverage||0)*100);
  const fre = fleschReadingEase(resume);

  const tipOverall = tipHTML(
    `<b>Overall (0–100)</b><br>
     Weighted sum capped at 100:
     <ul><li>ATS keywords: 0–40</li><li>Professionalism: 0–35</li><li>Structure: 0–15</li><li>Readability: 0–10</li></ul>
     Each point equals 1% of the ring score.`);

  const tipATS = tipHTML(
    `<b>ATS keywords (0–40)</b><br>
     ATS = Applicant Tracking System (resume scanners).
     <ul><li>Score = <b>40 × coverage</b> (matched ÷ total)</li><li>You matched <b>${present.length}</b> of <b>${totalKW}</b> keywords (${covPct}%).</li></ul>`);

  const tipPRO = tipHTML(
    `<b>Professionalism (0–35)</b><br>
     Bonuses for good writing; deductions for noisy patterns.
     <ul><li>Bonuses: bullet use, metric counts, healthy length</li><li>Penalties: exclamation marks, SHOUTING, passive voice, very long lines</li><li>Detected: bullets ${result.profDetails.bullets}, numbers ${result.profDetails.numbers}, passive ${result.profDetails.passive}, ! ${result.profDetails.exclam}, long lines ${result.profDetails.longLines}, CAPS ${result.profDetails.capsWords}</li></ul>`);

  const presentSections = Object.entries(result.sectionPresence).filter(([,v])=>v).map(([k])=>k);
  const missingSections = Object.entries(result.sectionPresence).filter(([,v])=>!v).map(([k])=>k);
  const tipSTRUCT = tipHTML(
    `<b>Structure (0–15)</b><br>
     <div class="helper" style="margin-top:4px">We look for: experience, education, skills, projects, certifications, summary, contact, awards.</div>
     <ul><li>Present: ${presentSections.join(', ') || '—'}</li><li>Missing: ${missingSections.join(', ') || '—'}</li></ul>`);

  const tipREAD = tipHTML(
    `<b>Readability (0–10)</b><br>
     Based on Flesch Reading Ease mapped to 0–10 (higher = easier).
     <ul><li>Your Flesch score: <b>${fre}</b></li></ul>`);

  const labelTips = { ATS: tipATS, Professionalism: tipPRO, Structure: tipSTRUCT, Readability: tipREAD };

  const breakdown=[
    {label:'ATS', val:result.breakdown.ats_keywords, max:40},
    {label:'Professionalism', val:result.breakdown.professionalism, max:35},
    {label:'Structure', val:result.breakdown.structure, max:15},
    {label:'Readability', val:result.breakdown.readability, max:10},
  ];
  const bhtml = breakdown.map(d=>`
    <div class="kpi">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <span class="helper" style="letter-spacing:.02em;display:flex;align-items:center;gap:6px">
          ${d.label} ${labelTips[d.label]}
        </span>
        <b>${d.val}/${d.max}</b>
      </div>
      <div class="bar" style="margin-top:6px">
        <div class="bar-fill" style="width:${pct(d.val,d.max)}%"></div>
      </div>
    </div>
  `).join('');

  const sectionPills = Object.entries(result.sectionPresence)
    .map(([name,isOn])=>`<span class="pill ${isOn?'good':'bad'}">${name}</span>`).join('');

  const fixes = friendlyFixes(result, fre).join('') || '<li><div class="fix-row"><span class="pill p-low">Nice!</span><span class="fix-title">You’re in solid shape</span></div><p class="fix-body">Consider tailoring a couple bullets to the job post.</p></li>';

  const out=document.getElementById('results');
  out.innerHTML=`
    <div>
      <div class="results-head">
        <div class="score-block">
          <div style="position:relative">${donutSVG(result.total, `${result.total}`)}</div>
          <div>
            <h2 class="card-title" style="margin:0;display:flex;align-items:center;gap:6px">
              Overall Score ${tipOverall}
            </h2>
            <div class="rating">${classifyScore(result.total)}</div>
          </div>
        </div>
        <span class="pill">${
          gate.mode==='free' ? 'Free scan used'
          : gate.mode==='credit' ? '1 paid credit used'
          : 'Unlimited (temp)'
        }</span>
      </div>

      <div class="kpi-grid">${bhtml}</div>

      <div style="margin-top:12px">
        <h3 class="card-title" style="margin:10px 0 6px">Keyword Coverage</h3>
        <div class="stack" aria-label="Keyword coverage stacked bar">
          <div class="ok" style="width:${covPct}%"></div>
          <div class="gap" style="width:${100-covPct}%"></div>
        </div>
        <div class="metrics">
          <div class="metric"><b>${present.length}</b> matched</div>
          <div class="metric"><b>${missing.length}</b> missing</div>
          <div class="metric"><b>${covPct}%</b> coverage</div>
        </div>
      </div>

     <h3 class="card-title" style="margin:14px 0 6px">Structure Checklist</h3>
      <div class="section-pills">${sectionPills}</div>

      <h3 class="card-title" style="margin:14px 0 6px">Extracted from Job Description</h3>
      <div>${result.extractedKeywords.map(k=>`<span class='pill good'>${k}</span>`).join('')}</div>

      <h3 class="card-title" style="margin:14px 0 6px">Matched Keywords</h3>
      <div>${present.map(k=>`<span class='pill good'>${k}</span>`).join('') || '<span class="pill bad">No matches yet</span>'}</div>

      <h3 class="card-title" style="margin:14px 0 6px">Missing Keywords</h3>
      <div>${missing.map(k=>`<span class='pill bad'>${k}</span>`).join('') || '<span class="pill good">No gaps detected</span>'}</div>



 

      <h3 class="card-title" style="margin:14px 0 6px">Readability & Tone</h3>
      <p class="helper" style="margin:0 0 8px">
        ${gradeReadability(result.breakdown.readability)}. Bullets: <b>${result.profDetails.bullets}</b>,
        metrics used: <b>${result.profDetails.numbers}</b>, passive uses: <b>${result.profDetails.passive}</b>.
      </p>

      <h3 class="card-title" style="margin:14px 0 6px">Top Fixes</h3>
      <ul class="list-tight">${fixes}</ul>
    </div>`;
}

/* ===== Upload handling ===== */
const fileInput = document.getElementById('resumeFile');
const fileLabel = document.getElementById('fileLabel');
const dropzone  = document.getElementById('dropzone');
const scanSpinner = document.getElementById('scanSpinner');
const scanText = document.getElementById('scanText');
document.getElementById('btnPick').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', e => { if (e.target.files?.[0]) handleResumeFile(e.target.files[0]); });

['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.add('drag'); }));
['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.remove('drag'); }));
dropzone.addEventListener('drop', e=>{
  const f = e.dataTransfer?.files?.[0];
  if (f) handleResumeFile(f);
});

/* Updated to drive the LED states based on your existing calls */
function setScanStatus(msg, spinning=false){
  const led = document.getElementById('statusLed');
  const spin = document.getElementById('scanSpinner');
  const txt  = document.getElementById('scanText');

  const m = String(msg||'').toLowerCase();
  let state = 'ready';
  if (spinning) state = 'scanning';
  else if (/(error|unsupported|fail)/.test(m)) state = 'error';
  else if (/(extracted|success|done|✓|scored)/.test(m)) state = 'done';

  led.classList.remove('ready','scanning','done','error');
  led.classList.add(state);
  spin.classList.toggle('show', !!spinning);
  txt.textContent = msg; // keep for screen readers (hidden)
}

async function handleResumeFile(file){
  fileLabel.textContent = file.name;
  setScanStatus('Scanning...', true);
  try{
    const ext = file.name.split('.').pop().toLowerCase();
    let text = '';
    if (ext === 'pdf'){
      text = await extractTextFromPDF(file);
    } else if (ext === 'docx'){
      text = await extractTextFromDOCX(file);
    } else if (ext === 'txt'){
      text = await file.text();
    } else if (ext === 'rtf'){
      const raw = await file.text();
      text = raw.replace(/\\'[0-9a-fA-F]{2}/g,' ')
                .replace(/\\[a-z]+\d*/g,' ')
                .replace(/[{}]/g,' ')
                .replace(/\\par/g,'\n');
    } else {
      setScanStatus('Unsupported file type. Use PDF, DOCX, or TXT.', false);
      return;
    }
    text = (text||'').trim();
    if (text.length < 20){
      setScanStatus('Could not extract much text — is it a scanned image PDF?', false);
      document.getElementById('resume').value = text;
      return;
    }
    document.getElementById('resume').value = text;
    setScanStatus('Text extracted ✓', false);   // will turn LED solid green
    analyze(); // auto-run after upload
  } catch(err){
    console.error(err);
    setScanStatus('Error reading file. Try another format.', false);
  }
}

/* PDF text extraction using PDF.js */
async function extractTextFromPDF(file){
  if (!window.pdfjsLib) throw new Error('PDF.js not loaded');
  const buf = await file.arrayBuffer();
  const loadingTask = pdfjsLib.getDocument({data: buf});
  const pdf = await loadingTask.promise;
  let fullText = '';
  for (let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const strings = content.items.map(it => ('str' in it ? it.str : it?.toString()) || '');
    fullText += strings.join(' ') + '\n';
  }
  return fullText.replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n');
}

/* DOCX text extraction using Mammoth */
async function extractTextFromDOCX(file){
  if (!window.mammoth) throw new Error('Mammoth not loaded');
  const arrayBuffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({arrayBuffer});
  return (result.value || '').replace(/\r/g,'').trim();
}

/* ===== Paywall & misc ===== */
function openPaywall(n=1){ window.__desiredCredits = n; document.getElementById('paywall').classList.add('open'); }
function closePaywall(){ document.getElementById('paywall').classList.remove('open'); }
async function startCheckout(n=1){
  addCredits(n);
  closePaywall();
  alert(`Added ${n} scan${n>1?'s':''}. Swap this with Stripe for production.`);
}
function addCredits(n){ writeMeter({creditAdd:n}); }
function clearAll(){
  document.getElementById('resume').value='';
  document.getElementById('jd').value='';
  document.getElementById('keywords').value='';
  document.getElementById('results').innerHTML = `
    <div style="text-align:center;color:var(--muted)">
      <div style="width:44px;height:44px;border-radius:9999px;margin:8px auto;background:linear-gradient(135deg,#60a5fa,#4f46e5)"></div>
      <h3 style="margin:6px 0 4px;color:var(--text)">Ready to score your resume</h3>
      <div class="helper">Paste your resume and click <b>Analyze</b>.</div>
    </div>`;
  fileInput.value = '';
  fileLabel.textContent = 'Choose PDF, DOCX, or TXT';
  setScanStatus('Ready', false); // hollow LED
}

updateMeterUI();
updatePricingUI();
/* Set initial LED state */
setScanStatus('Ready', false);
</script>
</body>
</html>
