<!--TEST 1-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rezzy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"> 

  <!-- PDF.js + Mammoth -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script>window.pdfjsLib && (pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js");</script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js" defer></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HC1DSZ3RED"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-HC1DSZ3RED');
  </script>
</head>
<body>
  <div class="container">
    <header class="topbar">
      <div class="brand">
        <img class="logo" src="logo.png" alt="Rezzy logo" />
        <div>
          <h1>Rezzy Rate</h1>
          <div class="helper">The smart resume checker</div>
        </div>
      </div>
      <div class="badges">
        <span class="badge" id="freeBadge">Free credits left today: 1</span>
        <span class="badge" id="creditBadge">Paid credits: 0</span>
      </div>
    </header>

    <main class="layout">
      <section class="card">
        <h2 class="card-title">Check to see if your resume is industry ready</h2>
        <p class="card-sub">Paste your resume and the job description. Or upload a file — we’ll extract the text and score it.</p>

        <div class="upload-row">
          <label class="file-pill" style="cursor:pointer">
            <input id="resumeFile" type="file" accept=".pdf,.docx,.txt,.rtf" />
            <span id="fileLabel">Choose PDF, DOCX, or TXT</span>
          </label>
          <button id="btnPick" class="file-btn" type="button" aria-label="Upload file">
            <svg xmlns="http://www.w3.org/2000/svg" 
                 width="18" height="18" viewBox="0 0 24 24" 
                 fill="none" stroke="currentColor" stroke-width="2" 
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          </button>
          
          <div id="dropzone" class="dropzone">drag & drop</div>

          <span class="helper" id="scanStatus" style="display:flex;align-items:center;gap:8px">
            <span class="statusled ready" id="statusLed" aria-hidden="true"></span>
            <span class="spinner" id="scanSpinner" aria-hidden="true"></span>
            <span id="scanText" class="sr-only">Ready</span>
          </span>
        </div>

        <label>Paste Resume Text</label>
        <textarea id="resume" rows="12">JOHN DOE
Detroit, MI • john.doe@email.com • (313) 555-1212

SUMMARY
Data-driven analyst with 5+ years improving KPI visibility and reducing cycle time across finance and operations.

EXPERIENCE
Acme Corp — Senior Analyst (2021–Present)
• Led dashboard rebuild, improving reporting speed by 35%.
• Automated monthly close with Python, saving 12 hours per cycle.
• Partnered with sales to forecast pipeline; reduced variance by 18%.

EDUCATION
B.S. in Information Systems, Michigan State University

SKILLS
SQL, Python, Tableau, Excel, Power BI, Forecasting, ETL</textarea>

        <label>Paste Job Description (optional)</label>
        <textarea id="jd" rows="4">We seek a Business Data Analyst to build SQL pipelines, automate reporting in Python, and create Tableau dashboards. Experience with forecasting, ETL, and stakeholder communication required.</textarea>

        <label>Add more keywords to compare (comma separated)</label>
        <input id="keywords" placeholder="SQL, Python, Tableau, ETL, forecasting" value="SQL, Python, Tableau, ETL, forecasting"/>

        <div class="actions" style="margin-top:6px">
          <button class="btn-primary" onclick="analyze()">Analyze</button>
          <button id="btnClear" class="btn-secondary" onclick="clearAll()">Clear</button>
          <span class="spacer"></span>
          <div class="pricing-buttons">
            <button id="btnBuy1Top"  class="btn-secondary btn-compact buy-btn" onclick="openPaywall(1)"></button>
            <button id="btnBuy10Top" class="btn-secondary btn-compact buy-btn" onclick="openPaywall(10)"></button>
            <button id="btnBuy20Top" class="btn-secondary btn-compact buy-btn" onclick="openPaywall(20)"></button>
          </div>
        </div>
      </section>

      <section id="results" class="card">
        <div style="text-align:center;color:var(--muted)">
          <div style="width:44px;height:44px;border-radius:9999px;margin:8px auto;background:linear-gradient(135deg,#60a5fa,#4f46e5)"></div>
          <h3 style="margin:6px 0 4px;color:var(--text)">Ready to score your resume</h3>
          <div class="helper">Paste your resume or upload a file, then click <b>Analyze</b>.</div>
        </div>
      </section>
    </main>

    <footer style="margin-top:40px;padding:20px 0;border-top:1px solid var(--border);text-align:center;font-size:13px;color:var(--muted)">
      <p style="margin:6px 0">
        <a href="about.html" style="color:var(--accent);text-decoration:none;margin:0 10px">About</a> •
        <a href="privacy.html" style="color:var(--accent);text-decoration:none;margin:0 10px">Privacy Policy</a>
      </p>
      <p style="margin:6px 0">&copy; 2025 Rezzy Rate. All rights reserved.</p>
    </footer>
  </div>

  <div id="paywall" class="overlay" aria-modal="true" role="dialog">
    <div class="card modal">
      <h2 class="card-title" style="margin-top:0">Get more scans</h2>
      <p id="paywallLeadText" class="card-sub" style="margin-bottom:12px">
        You used your free daily scan. Buy additional scans for <strong>$0.49</strong> or save with a pack.
      </p>
      <div class="actions">
        <div class="pricing-buttons">
          <button id="btnBuy1Modal"  class="btn-primary btn-compact buy-btn" onclick="startCheckout(1)"></button>
          <button id="btnBuy10Modal" class="btn-primary btn-compact buy-btn" onclick="startCheckout(10)"></button>
          <button id="btnBuy20Modal" class="btn-primary btn-compact buy-btn" onclick="startCheckout(20)"></button>
        </div>
        <span class="spacer"></span>
        <button class="btn-secondary btn-compact" onclick="closePaywall()">Close</button>
      </div>
      <p class="helper" style="margin-top:12px">Dev mode: This demo adds credits to localStorage. Replace <code>startCheckout</code> with Stripe Checkout + webhook.</p>
    </div>
  </div>

  <script>
    /* ===== Prices ===== */
    const PRICES = { single: 0.49, pack10: 3.99, pack20: 5.99 };
    const fmt = n => `$${n.toFixed(2)}`;
    function updatePricingUI(){
      const p1 = fmt(PRICES.single), p10 = fmt(PRICES.pack10), p20 = fmt(PRICES.pack20);
      const lead = document.getElementById('paywallLeadText');
      if (lead) lead.innerHTML = `You used your free daily scan. Buy additional scans for <strong>${p1}</strong> or save with a pack.`;
      const setBtn = (id, qty, price) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = `<span class="btn-label">${qty} ${qty===1?'Scan':'Scans'}</span><span class="btn-price">${price}</span>`;
      };
      setBtn('btnBuy1Top', 1,  p1); setBtn('btnBuy10Top',10, p10); setBtn('btnBuy20Top',20, p20);
      setBtn('btnBuy1Modal', 1,  p1); setBtn('btnBuy10Modal',10, p10); setBtn('btnBuy20Modal',20, p20);
    }
    
    /* ===== Metering & Paywall ===== */
    const LS_KEYS = { lastDate:'rc_lastDate', dailyUsed:'rc_dailyUsed', credits:'rc_credits', unlimitedUntil:'rc_unlimited_until', savedJobs:'rc_saved_jobs' };
    (function handleUnlimitedFlag(){
      const params = new URLSearchParams(location.search);
      const hours = 48;
      if (params.get('unlimited') === '1'){
        localStorage.setItem(LS_KEYS.unlimitedUntil, String(Date.now() + hours*60*60*1000));
        try{ history.replaceState(null,'',location.pathname); }catch(e){}
      } else if (params.get('unlimited') === '0'){
        localStorage.removeItem(LS_KEYS.unlimitedUntil);
        try{ history.replaceState(null,'',location.pathname); }catch(e){}
      }
    })();
    function isUnlimited(){ const until = parseInt(localStorage.getItem(LS_KEYS.unlimitedUntil)||'0',10); return Date.now() < until; }
    const todayStr = () => { const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); };
    function readMeter(){
      const today = todayStr();
      const last = localStorage.getItem(LS_KEYS.lastDate);
      if (last !== today){ localStorage.setItem(LS_KEYS.lastDate, today); localStorage.setItem(LS_KEYS.dailyUsed, '0'); }
      const freeUsed = parseInt(localStorage.getItem(LS_KEYS.dailyUsed)||'0',10);
      const credits = parseInt(localStorage.getItem(LS_KEYS.credits)||'0',10);
      return { freeLeft: Math.max(0, 1 - freeUsed), credits };
    }
    function writeMeter({freeConsumed=0, creditConsumed=0, creditAdd=0}={}){
      const used = parseInt(localStorage.getItem(LS_KEYS.dailyUsed)||'0',10) + freeConsumed;
      const credits = Math.max(0, parseInt(localStorage.getItem(LS_KEYS.credits)||'0',10) - creditConsumed + creditAdd);
      localStorage.setItem(LS_KEYS.dailyUsed, String(used));
      localStorage.setItem(LS_KEYS.credits, String(credits));
      updateMeterUI();
    }
    function updateMeterUI(){
      const {freeLeft, credits} = readMeter();
      document.getElementById('creditBadge').textContent = `Paid credits: ${credits}`;
      document.getElementById('freeBadge').textContent = isUnlimited() ? 'Free scans left today: ∞ (temp)' : `Free scans left today: ${freeLeft}`;
    }
    function canConsumeScan(){
      if (isUnlimited()) return { ok:true, mode:'unlimited' };
      const {freeLeft, credits} = readMeter();
      if (freeLeft > 0) return { ok:true, mode:'free' };
      if (credits > 0) return { ok:true, mode:'credit' };
      return { ok:false, mode:'pay' };
    }
    function consumeScan(mode){ if (mode==='free') writeMeter({freeConsumed:1}); else if (mode==='credit') writeMeter({creditConsumed:1}); }
    
    /* ===== Heuristic scoring ===== */
    const STOPWORDS = new Set(["the","a","an","and","or","but","if","then","else","of","to","in","for","on","at","with","by","from","as","that","this","these","those","is","are","was","were","be","been","being","it","its","your","you","i","me","my","we","our","they","their"]);
    const SECTION_HINTS = ["experience","education","skills","projects","certifications","summary","contact","awards"];
    const normalize = t => (t||"").replace(/\u2022/g,"-").replace(/[\t\r]/g," ").trim();
    const tokenize = t => normalize(t).toLowerCase().replace(/[^a-z0-9%$+\-\s]/g," ").split(/\s+/).filter(Boolean);
    const wordFreq = t => { const f=new Map(); for(const w of tokenize(t)){ if(STOPWORDS.has(w)||w.length<3) continue; f.set(w,(f.get(w)||0)+1);} return f; };
    const extractKeywords = (t,n=15)=> [...wordFreq(t).entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([w])=>w);
    const unique = a => [...new Set(a.filter(Boolean))];
    const countNumbers = t => (t.match(/(^|\s)(\$?\d+[\d,]*(\.?\d+)?%?)/g)||[]).length;
    function bulletStats(t){ const lines=normalize(t).split(/\n+/); return { bullets:lines.filter(l=>/^\s*[-•*]/.test(l)).length, exclam:(t.match(/!/g)||[]).length, capsWords:(t.match(/\b[A-Z]{4,}\b/g)||[]).length, longLines:lines.filter(l=>l.length>160).length }; }
    const passiveVoiceCount = t => (t.match(/\b(?:was|were|is|are|been|being|be)\s+[a-z]+ed\b/gi)||[]).length;
    function fleschReadingEase(t){ const s=(t.match(/[.!?]+/g)||["."]).length; const words=tokenize(t); const wc=Math.max(words.length,1); const syl=words.reduce((sum,w)=>sum+ (w.match(/[aeiouy]{1,2}/g)||[]).length,0); const ASL=wc/s; const ASW=syl/wc; return Math.max(0,Math.min(100,Math.round(206.835-1.015*ASL-84.6*ASW))); }
    const presenceScore = t => Math.min(15, Math.round((SECTION_HINTS.filter(s=> normalize(t).toLowerCase().includes(s)).length/5)*15));
    function keywordScore(resume,keywords){
      const rTokens=new Set(tokenize(resume));
      const list=unique(keywords.map(k=>k.toLowerCase().trim()).filter(k=>k.length>0));
      const present=[]; const missing=[];
      for(const k of list){ (rTokens.has(k)?present:missing).push(k); }
      const coverage=list.length?present.length/list.length:0;
      return { score:Math.round(40*coverage), missing, present, coverage, total:list.length };
    }
    function professionalismScore(r){
      const {bullets,exclam,capsWords,longLines}=bulletStats(r);
      const pv=passiveVoiceCount(r);
      const words=tokenize(r).length;
      let score=35;
      if(exclam>0)score-=Math.min(5,exclam*2);
      score-=Math.min(5,Math.floor(capsWords/5));
      score-=Math.min(5,Math.floor(pv/4));
      score-=Math.min(5,longLines);
      if(bullets>=5)score+=2;
      if(countNumbers(r)>=3)score+=3;
      if(words>=250&&words<=900)score+=2;
      return {score:Math.max(0,Math.min(35,Math.round(score))), details:{bullets,exclam,capsWords,longLines,passive:pv,words,numbers:countNumbers(r)}};
    }
    const readabilityScore = r => Math.round((fleschReadingEase(r)/100)*10);
    function scoreResume(resume,jd,userKeywords){
      const extracted=extractKeywords(jd||"");
      const combined=unique([...(userKeywords||[]),...extracted]);
      const kw=keywordScore(resume,combined);
      const prof=professionalismScore(resume);
      const pres=presenceScore(resume);
      const read=readabilityScore(resume);
      const total=Math.max(0,Math.min(100,Math.round(kw.score+prof.score+pres+read)));
      return{
        total,
        breakdown:{ats_keywords:kw.score,professionalism:prof.score,structure:pres,readability:read},
        coverage:kw.coverage, missingKeywords:kw.missing, presentKeywords:kw.present, totalKeywords:kw.total,
        extractedKeywords:extracted,
        profDetails:prof.details,
        sectionPresence: SECTION_HINTS.reduce((acc,s)=>{ acc[s]=normalize(resume).toLowerCase().includes(s); return acc; },{})
      };
    }
    const pct = (val,max)=> Math.round((max?val/max:0)*100);
    function classifyScore(total){ if(total>=85) return "Excellent"; if(total>=70) return "Strong"; if(total>=55) return "Fair"; return "Needs work"; }
    function gradeReadability(r){ if(r>=8) return "Very easy to skim"; if(r>=6) return "Plain & readable"; if(r>=5) return "Somewhat dense"; if(r>=3) return "Hard to read"; return "Very hard to read"; }

    /* ---------- Top Fixes (human-friendly) ---------- */
    function friendlyFixes(result, fre){
      const tips = [];
      const present = (result.presentKeywords || []);
      const missing = (result.missingKeywords || []);
      const totalKW = result.totalKeywords || (present.length + missing.length);
      const perKw = totalKW ? Math.max(1, Math.round(40 / totalKW)) : 0;
      const tag = (p) =>
        p === 'high' ? '<span class="pill p-high">Quick win</span>' :
        p === 'med'  ? '<span class="pill p-med">Worth doing</span>' :
                       '<span class="pill p-low">Nice to have</span>';
      const addTip = (priority, title, body) =>
        tips.push(`<li>
          <div class="fix-row">${tag(priority)}<span class="fix-title">${title}</span></div>
          <p class="fix-body">${body}</p>
        </li>`);
      if (missing.length){
        const show = missing.slice(0, 10);
        addTip('high','Add a few missing keywords',`Work in the terms the job uses — ${show.join(', ')}. Each one should bump your ATS score by about +${perKw}.`);
      }
      if (result.profDetails.numbers < 3){
        addTip('high','Show the impact with numbers',`You’ve got ${result.profDetails.numbers}. Aim for 3–5 clear wins like “cut processing time 30%,” “saved $50K,” or “reduced variance 18%.”`);
      }
      const missingSections = Object.entries(result.sectionPresence).filter(([, v]) => !v).map(([k]) => k);
      if (missingSections.length){
        addTip('med','Fill the missing sections',`Add ${missingSections.join(', ')} so recruiters (and ATS) can find the essentials fast.`);
      }
      if (!result.sectionPresence.summary){
        addTip('med','Write a short summary',`Two–three lines: your title, core tools, and one impact line. Example: “Business Data Analyst • SQL, Python, Tableau • automate reporting and improve forecast accuracy.”`);
      }
      if (result.profDetails.passive > 3){
        addTip('med','Use active verbs',`I spotted ${result.profDetails.passive} passive phrases. Swap “was built / were automated” for “Built,” “Automated,” “Forecasted.”`);
      }
      if (result.profDetails.bullets < 5){
        addTip('med','Add a few more bullets',`You have ${result.profDetails.bullets}. Aim ~5–7 bullets for recent roles and ~3–5 for older ones.`);
      }
      if (result.breakdown.readability <= 5 || fre < 55){
        addTip('med','Smooth the reading flow',`Your Flesch score is ${fre}. Keep sentences ~12–18 words, split long lines into bullets, and prefer clear wording. Aim for 60+.`);
      }
      if (result.profDetails.longLines > 0){
        addTip('low','Break up long lines',`${result.profDetails.longLines} line(s) are quite long. Keep bullets under ~160 characters.`);
      }
      if (result.profDetails.capsWords > 6){
        addTip('low','Dial back ALL CAPS',`${result.profDetails.capsWords} ALL-CAPS words found.`);
      }
      if (result.profDetails.exclam > 0){
        addTip('low','Skip exclamation marks','You don’t need them — the results can carry the energy.');
      }
      if (result.profDetails.words < 300){
        addTip('low','Add a bit more substance',`${result.profDetails.words} words now. A one-pager usually lands around 400–700 words.`);
      } else if (result.profDetails.words > 950){
        addTip('low','Tighten the length',`${result.profDetails.words} words total.`);
      }
      addTip('low','Keep it ATS-friendly','Use a single column, simple headings, and export to a text-based PDF.');
      if (present.length && missing.length){
        addTip('low','Match the job’s phrasing','Mirror wording when it makes sense so scanners don’t miss it.');
      }
      return tips.slice(0, 12);
    }

    /* ===== Jobs ===== */
    const CANON_SKILLS = ["sql","python","tableau","power bi","excel","etl","forecasting","dashboard","dashboards","pipeline","pipelines","bi","powerbi","power"];
    const ROLE_TEMPLATES = [
      {title:"Data Analyst", bucket:"Data"},
      {title:"Senior Data Analyst", bucket:"Data"},
      {title:"Lead Data Analyst", bucket:"Data"},
      {title:"Business Data Analyst", bucket:"Data"},
      {title:"Business Intelligence Analyst", bucket:"BI"},
      {title:"Reporting Analyst (SQL/Tableau)", bucket:"BI"},
      {title:"Analytics Engineer", bucket:"Eng"},
      {title:"Junior Analytics Engineer", bucket:"Eng"},
      {title:"Product Analyst (Data)", bucket:"Product"},
      {title:"Growth / Marketing Analyst", bucket:"Marketing"},
      {title:"Financial Data Analyst", bucket:"Finance"},
      {title:"Revenue / FP&A Analyst", bucket:"Finance"},
      {title:"Operations Data Analyst", bucket:"Ops"},
      {title:"Supply Chain Data Analyst", bucket:"Ops"}
    ];
    const SENIORITY_BY_TITLE = (t)=> /lead|senior/i.test(t) ? "Senior" : /junior/i.test(t) ? "Entry" : "Mid";

    function pickLocationFromResume(t){
      const m = (t.match(/[A-Za-z .'-]+,\s*[A-Z]{2}/) || [])[0];
      return m ? m.replace(/\s+/g,' ').trim() : "Remote";
    }
    function topSkillsFromResume(t){
      const low = t.toLowerCase();
      const found = CANON_SKILLS.filter(s => low.includes(s));
      const pretty = s => s
        .replace('power bi','Power BI').replace('powerbi','Power BI')
        .replace(/^sql$/i,'SQL').replace(/^etl$/i,'ETL').replace(/^bi$/i,'BI')
        .replace(/^python$/i,'Python').replace(/^excel$/i,'Excel').replace(/^tableau$/i,'Tableau')
        .replace(/^pipeline(s)?$/i,'Pipelines').replace(/^dashboard(s)?$/i,'Dashboards')
        .replace(/^forecasting$/i,'Forecasting').replace(/^power$/i,'Power BI');
      return Array.from(new Set(found.map(pretty)));
    }

    /* Only LinkedIn & Indeed URLs are accepted for "verified" cards */
    const ALLOWED_JOB_HOST_PATTERNS = [/(\.|^)linkedin\.com\/jobs/i, /(\.|^)indeed\.com/i];
    const RELEVANCE_TOKENS = ["data","analyst","analytics","bi","business-intelligence","sql","python","tableau","power-bi","powerbi","etl","reporting","dashboard","pipelines","forecast"];
    function urlLooksLegitAndRelevant(urlStr){
      let u; try{ u = new URL(urlStr); }catch{ return {ok:false, reason:"Invalid URL"}; }
      const ok = ALLOWED_JOB_HOST_PATTERNS.some(rx => rx.test((u.hostname+u.pathname).toLowerCase()));
      if (!ok) return {ok:false, reason:"Only LinkedIn and Indeed links are accepted"};
      const hay = (u.pathname + " " + u.search).toLowerCase();
      if (!RELEVANCE_TOKENS.some(t => hay.includes(t))) return {ok:false, reason:"URL path lacks relevant analyst/data keywords"};
      return {ok:true};
    }

    /* Local overrides (optional manual pins) */
    const JOB_OVERRIDES_KEY = 'rc_job_overrides';
    const getOverrides = () => { try { return JSON.parse(localStorage.getItem(JOB_OVERRIDES_KEY) || '{}'); } catch { return {}; } };
    const saveOverrides = map => localStorage.setItem(JOB_OVERRIDES_KEY, JSON.stringify(map || {}));

    function setExactPosting(title){
      const map = getOverrides();
      const cur = map[title] || {};
      const url = prompt('Paste the exact job link (LinkedIn or Indeed only):', cur.url || '');
      if (!url){ delete map[title]; saveOverrides(map); renderJobsGrid(); return; }
      const check = urlLooksLegitAndRelevant(url);
      if (!check.ok){ alert(`Rejected: ${check.reason}`); return; }
      const city = prompt('City, ST as shown on the posting (e.g., Detroit, MI):', cur.city || '');
      const pay  = prompt('Salary range exactly as posted (e.g., $83k–$113k or $40–$55/hr):', cur.pay || '');
      const mode = prompt('Work mode (Remote / Hybrid / On-site):', cur.mode || '');
      map[title] = { url, city, pay, mode };
      saveOverrides(map);
      renderJobsGrid();
    }

    function openAddLinks(){
      const msg = `Paste 1–10 job links (each on a new line).\n\nAccepted: LinkedIn Jobs and Indeed only.`;
      const raw = prompt(msg, ""); if (!raw) return;
      const urls = raw.split(/\s*\n+\s*/).map(s=>s.trim()).filter(Boolean).slice(0,10);
      const map = getOverrides(); let added = 0, rejected = 0;
      const titles = JOBS_STATE.all.map(j => j.title);
      const lowerTitle = t => t.toLowerCase();
      urls.forEach(u=>{
        const v = urlLooksLegitAndRelevant(u); if (!v.ok){ rejected++; return; }
        const tokenized = (new URL(u).pathname.toLowerCase()).split(/[^a-z]+/g);
        const pick = titles.find(t=>{
          const toks = lowerTitle(t).split(/[^a-z]+/g);
          return toks.some(x => x && tokenized.includes(x));
        }) || titles[0];
        const cur = map[pick] || {};
        map[pick] = { url: u, city: cur.city || "", pay: cur.pay || "", mode: cur.mode || "" };
        added++;
      });
      saveOverrides(map); renderJobsGrid();
      alert(`Added ${added} link(s). ${rejected ? rejected + ' rejected (must be LinkedIn or Indeed and relevant).' : ''}`);
    }

    /* Helpers for role recommendations */
    function roleLine(skills){
      const s = skills.slice(0,3);
      const map = {
        "SQL":"own SQL pipelines","Python":"automate reporting in Python","Tableau":"ship Tableau dashboards",
        "Power BI":"build Power BI reports","Forecasting":"improve forecasting accuracy","ETL":"maintain ETL workflows",
        "Pipelines":"scale data pipelines","Dashboards":"design executive dashboards","Excel":"analyze in Excel"
      };
      const bits = s.map(x=>map[x]||`use ${x}`); return bits.slice(0,2).join(", ")+(bits[2]?`, ${bits[2]}`:"");
    }
    function matchScoreFor(role, skills, presentKeywords){
      const roleTokens = role.toLowerCase().split(/[^a-z]+/g);
      const skillSet = new Set(skills.map(s=>s.toLowerCase()));
      (presentKeywords||[]).forEach(k=>skillSet.add((k||"").toLowerCase()));
      const hits = roleTokens.filter(t=>skillSet.has(t) || ["data","analyst","analytics","bi","sql","python"].includes(t)).length;
      const base = 65 + Math.min(25, skills.length*4) + hits*2;
      return Math.max(60, Math.min(96, base));
    }
    function expandRoles(){
      const flavors = ["", " (SQL/Tableau)", " (Python/ETL)", " (Power BI)"];
      const out = [];
      ROLE_TEMPLATES.forEach(rt=>{
        flavors.forEach(f=>{
          const title = (rt.title + f).replace(/\s+/g,' ').trim();
          out.push({ title, bucket: rt.bucket, seniority: SENIORITY_BY_TITLE(title) });
        });
      });
      return out.slice(0, 60);
    }
    function recommendJobs(resumeText, presentKeywords=[]){
      const loc = pickLocationFromResume(resumeText);
      const skills = topSkillsFromResume(resumeText);
      const tags = Array.from(new Set([...(skills||[]), ...(presentKeywords||[]).slice(0,3).map(k=>k[0]?.toUpperCase()+k.slice(1))])).slice(0,6);
      const jobs = expandRoles().map(meta=>{
        const score = matchScoreFor(meta.title, skills, presentKeywords);
        const line = roleLine(skills);
        return { ...meta, tags, score, line, softLocation: loc, softMode: loc.toLowerCase().includes('remote') ? 'Remote' : 'Hybrid' };
      });
      return jobs.sort((a,b)=>b.score-a.score).slice(0,50);
    }

    /* ---------- NEW: Related job ads (LinkedIn & Indeed) ---------- */
    const mkQuery = (title, skills=[]) => encodeURIComponent(`${title} ${skills.slice(0,2).join(' ')}`.trim());
    const mkLoc   = (loc="") => encodeURIComponent(loc || "Remote");

    function liSearchUrl(title, loc, skills){
      return `https://www.linkedin.com/jobs/search/?keywords=${mkQuery(title, skills)}&location=${mkLoc(loc)}`;
    }
    function indeedSearchUrl(title, loc, skills){
      return `https://www.indeed.com/jobs?q=${mkQuery(title, skills)}&l=${mkLoc(loc)}`;
    }

    function relatedJobsSectionHTML(jobs){
      const top = jobs.slice(0,8);
      const cards = top.map(j=>{
        const li = liSearchUrl(j.title, j.softLocation, j.tags);
        const indd = indeedSearchUrl(j.title, j.softLocation, j.tags);
        return `
          <div class="job-card" data-bucket="${j.bucket}">
            <div class="job-head">
              <h4 class="job-title">${j.title}</h4>
              <div class="job-meta">
                <span class="badge-mini">${j.softLocation}</span>
                <span class="badge-mini">${j.seniority}</span>
                <span class="chip mini">${j.softMode}</span>
              </div>
            </div>
            <div class="job-line">${j.line}; scan current openings and apply fast.</div>
            <div class="job-tags">${(j.tags||[]).map(t=>`<span class="pill">${t}</span>`).join('')}</div>
            <div class="job-footer">
              <a class="job-btn brand" href="${li}"   target="_blank" rel="noopener"><span class="label">Open on LinkedIn</span></a>
              <a class="job-btn"        href="${indd}" target="_blank" rel="noopener"><span class="label">Open on Indeed</span></a>
              <div class="job-aux"></div>
            </div>
          </div>`;
      }).join('');
      return `
        <div class="jobs-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div>
              <h3 class="card-title" style="margin:14px 0 6px">Related Job Ads</h3>
              <p class="card-sub" style="margin-top:0">Direct searches on <b>LinkedIn</b> and <b>Indeed</b>, based on your resume.</p>
            </div>
          </div>
          <div class="jobs" id="relatedJobsGrid">${cards}</div>
        </div>`;
    }

    /* ===== Verified (manual) section + rendering/paging ===== */
    let JOB_FILTER = { mode:"any", bucket:"any" };
    const JOBS_STATE = { all:[], page:0, pageSize:12 };
    
    function jobsToolbarHTML(){
      const btn = (label, key, val)=>`<button type="button" data-key="${key}" data-val="${val}">${label}</button>`;
      return `
        <div class="jobs-toolbar">
          <div class="seg" id="modeSeg">
            ${btn('All modes','mode','any')}${btn('Remote','mode','Remote')}${btn('Hybrid','mode','Hybrid')}${btn('On-site','mode','On-site')}
          </div>
          <div class="seg" id="bucketSeg">
            ${btn('All roles','bucket','any')}${btn('Data','bucket','Data')}${btn('BI','bucket','BI')}${btn('Eng','bucket','Eng')}${btn('Finance','bucket','Finance')}${btn('Ops','bucket','Ops')}${btn('Product','bucket','Product')}${btn('Marketing','bucket','Marketing')}
          </div>
          <span class="helper">Only exact postings from <b>LinkedIn</b> and <b>Indeed</b> are shown.</span>
        </div>`;
    }

    function buildJobCardHTML(j){
      const overrides = getOverrides()[j.title] || {};
      if (!overrides.url) return "";
      const validation = urlLooksLegitAndRelevant(overrides.url);
      if (!validation.ok) return "";
      const accurateCity = overrides.city || '';
      const accuratePay  = overrides.pay  || '—';
      const accurateMode = overrides.mode || j.softMode || '—';
      return `
        <div class="job-card" data-mode="${accurateMode}" data-bucket="${j.bucket}">
          <div class="job-head">
            <h4 class="job-title">${j.title}</h4>
            <div class="job-meta">
              <span class="badge-mini">${accurateCity || j.softLocation}</span>
              <span class="badge-mini">${j.seniority}</span>
              <span class="chip mini">${accuratePay}</span>
              <span class="chip mini">${accurateMode}</span>
              <span class="chip mini ok" title="Verified job posting">Verified</span>
            </div>
          </div>
          <div class="job-line">${j.line}; define KPIs, set up quality checks, and present insights to stakeholders to drive decisions.</div>
          <div class="job-tags">${(j.tags||[]).map(t=>`<span class="pill">${t}</span>`).join('')}</div>
          <div class="job-footer">
            <a class="job-btn brand" href="${overrides.url}" target="_blank" rel="noopener"><span class="label">View job</span></a>
            <div class="job-aux">
              <button class="file-btn" title="Edit posting details" onclick="setExactPosting('${j.title.replace(/'/g, "\\'")}')">Edit</button>
            </div>
          </div>
        </div>`;
    }

    function jobsSectionHTML(jobs){
      JOBS_STATE.all = jobs;
      JOBS_STATE.page = 0;
      return `
        <div class="jobs-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div>
              <h3 class="card-title" style="margin:14px 0 6px">Verified Job Postings</h3>
              <p class="card-sub" style="margin-top:0">Only real postings from <b>LinkedIn</b> and <b>Indeed</b>. One link per card.</p>
            </div>
            <div class="flex" style="display:flex;gap:8px">
              <button class="btn-secondary btn-compact" onclick="openAddLinks()">Paste LinkedIn/Indeed links</button>
            </div>
          </div>
          ${jobsToolbarHTML()}
          <div class="jobs" id="jobsGrid"></div>
          <div class="load-more"><button id="loadMoreBtn" class="btn-secondary">Load more</button></div>
        </div>`;
    }

    function renderJobsGrid(){
      const grid = document.getElementById('jobsGrid');
      if (!grid) return;
      const filtered = JOBS_STATE.all.filter(j => {
        const o = getOverrides()[j.title] || {};
        if (!o.url) return false;
        const v = urlLooksLegitAndRelevant(o.url);
        if (!v.ok) return false;
        const modeNow = (o.mode || j.softMode);
        return (JOB_FILTER.mode==='any'   || modeNow===JOB_FILTER.mode) &&
               (JOB_FILTER.bucket==='any' || j.bucket===JOB_FILTER.bucket);
      });
      const end = Math.min(filtered.length, (JOBS_STATE.page+1)*JOBS_STATE.pageSize);
      const html = filtered.slice(0, end).map(buildJobCardHTML).join('');
      grid.innerHTML = html || `
        <div class="helper" style="text-align:center;padding:18px">
          No verified job ads yet. Click <b>Paste LinkedIn/Indeed links</b> to add exact postings.
        </div>`;
      const btn = document.getElementById('loadMoreBtn');
      if (btn){
        btn.style.display = end < filtered.length ? '' : 'none';
        btn.onclick = () => { JOBS_STATE.page++; renderJobsGrid(); };
      }
    }

    function wireToolbar(){
      const bindSeg = (segId, key) => {
        const seg = document.getElementById(segId); if (!seg) return;
        seg.querySelectorAll('button').forEach(btn=>{
          const v = btn.getAttribute('data-val');
          const setActive = () => {
            seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
          };
          if ((JOB_FILTER[key]==='any' && v==='any') || JOB_FILTER[key]===v) setActive();
          btn.onclick = () => { JOB_FILTER[key]=v; setActive(); JOBS_STATE.page = 0; renderJobsGrid(); };
        });
      };
      bindSeg('modeSeg','mode'); bindSeg('bucketSeg','bucket');
    }

    /* ===== Render results ===== */
    function donutSVG(percent,label){
      const r=28, c=2*Math.PI*r, off=c*(1-percent/100);
      const gid = `g${Math.random().toString(36).slice(2,7)}`;
      return `
      <svg class="donut" viewBox="0 0 72 72" role="img" aria-label="Score ${percent}%">
        <defs><linearGradient id="${gid}" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#818cf8"/><stop offset="100%" stop-color="#4f46e5"/></linearGradient></defs>
        <circle cx="36" cy="36" r="${r}" fill="none" stroke="rgba(148,163,184,.25)" stroke-width="8"/>
        <circle cx="36" cy="36" r="${r}" fill="none" stroke="url(#${gid})" stroke-width="8" stroke-linecap="round" stroke-dasharray="${c}" stroke-dashoffset="${off}" transform="rotate(-90 36 36)"/>
      </svg>
      <div class="center">${label}</div>`;
    }
    const tipHTML = inner => `
      <span class="tip">
        <button class="tip-btn" type="button" aria-label="More info">i</button>
        <span class="tip-bubble" role="tooltip">${inner}<span class="arrow" aria-hidden="true"></span></span>
      </span>`;

    function analyze(){
      const gate = canConsumeScan(); if (!gate.ok){ openPaywall(); return; }

      const resume=document.getElementById('resume').value;
      const jd=document.getElementById('jd').value;
      const keywords=(document.getElementById('keywords').value||'').split(/,|\n/).map(s=>s.trim()).filter(Boolean);
      const result=scoreResume(resume,jd,keywords);

      consumeScan(gate.mode);

      const present=(result.presentKeywords||[]);
      const missing=(result.missingKeywords||[]);
      const totalKW = present.length + missing.length;
      const covPct = Math.round((result.coverage||0)*100);
      const fre = fleschReadingEase(resume);

      const tipOverall = tipHTML(`<b>Overall (0–100)</b><br>ATS 0–40, Professionalism 0–35, Structure 0–15, Readability 0–10.`);
      const tipATS = tipHTML(`<b>ATS keywords (0–40)</b><br>Score = 40 × coverage. You matched <b>${present.length}</b> of <b>${totalKW}</b> (${covPct}%).`);
      const tipPRO = tipHTML(`<b>Professionalism (0–35)</b><br>Bonuses: bullets, metrics, length. Penalties: shouting, passive voice, long lines.`);
      const presentSections = Object.entries(result.sectionPresence).filter(([,v])=>v).map(([k])=>k);
      const missingSections = Object.entries(result.sectionPresence).filter(([,v])=>!v).map(([k])=>k);
      const tipSTRUCT = tipHTML(`<b>Structure (0–15)</b><br>Present: ${presentSections.join(', ')||'—'}<br>Missing: ${missingSections.join(', ')||'—'}`);
      const tipREAD = tipHTML(`<b>Readability (0–10)</b><br>Flesch: <b>${fre}</b>.`);

      const breakdown=[
        {label:'ATS', val:result.breakdown.ats_keywords, max:40},
        {label:'Professionalism', val:result.breakdown.professionalism, max:35},
        {label:'Structure', val:result.breakdown.structure, max:15},
        {label:'Readability', val:result.breakdown.readability, max:10},
      ];
      const bhtml = breakdown.map(d=>`
        <div class="kpi">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <span class="helper" style="letter-spacing:.02em;display:flex;align-items:center;gap:6px">
              ${d.label} ${({'ATS':tipATS,'Professionalism':tipPRO,'Structure':tipSTRUCT,'Readability':tipREAD})[d.label]}
            </span>
            <b>${d.val}/${d.max}</b>
          </div>
          <div class="bar" style="margin-top:6px"><div class="bar-fill" style="width:${pct(d.val,d.max)}%"></div></div>
        </div>
      `).join('');

      const sectionPills = Object.entries(result.sectionPresence)
        .map(([name,isOn])=>`<span class="pill ${isOn?'good':'bad'}">${name}</span>`).join('');

      const fixes = friendlyFixes(result, fre).join('') || '<li><div class="fix-row"><span class="pill p-low">Nice!</span><span class="fix-title">You’re in solid shape</span></div><p class="fix-body">Tailor a couple bullets to the job post.</p></li>';

      const jobs = recommendJobs(resume, result.presentKeywords);
      const relatedHTML = relatedJobsSectionHTML(jobs);           /* NEW */
      const verifiedHTML = jobsSectionHTML(jobs);                 /* manual pins */
      
      const out=document.getElementById('results');
      out.innerHTML=`
        <div>
          <div class="results-head">
            <div class="score-block">
              <div style="position:relative">${donutSVG(result.total, `${result.total}`)}</div>
              <div>
                <h2 class="card-title" style="margin:0;display:flex;align-items:center;gap:6px">Overall Score ${tipOverall}</h2>
                <div class="rating">${classifyScore(result.total)}</div>
              </div>
            </div>
            <span class="pill">${
              gate.mode==='free' ? 'Free scan used'
              : gate.mode==='credit' ? '1 paid credit used'
              : 'Unlimited (temp)'
            }</span>
          </div>

          <div class="kpi-grid">${bhtml}</div>

          <div style="margin-top:12px">
            <h3 class="card-title" style="margin:10px 0 6px">Keyword Coverage</h3>
            <div class="stack" aria-label="Keyword coverage stacked bar">
              <div class="ok" style="width:${covPct}%"></div><div class="gap" style="width:${100-covPct}%"></div>
            </div>
            <div class="metrics">
              <div class="metric"><b>${present.length}</b> matched</div>
              <div class="metric"><b>${missing.length}</b> missing</div>
              <div class="metric"><b>${covPct}%</b> coverage</div>
            </div>
          </div>

          <h3 class="card-title" style="margin:14px 0 6px">Structure Checklist</h3>
          <div class="section-pills">${sectionPills}</div>

          <h3 class="card-title" style="margin:14px 0 6px">Extracted from Job Description</h3>
          <div>${result.extractedKeywords.map(k=>`<span class='pill good'>${k}</span>`).join('')}</div>

          <h3 class="card-title" style="margin:14px 0 6px">Matched Keywords</h3>
          <div>${present.map(k=>`<span class='pill good'>${k}</span>`).join('') || '<span class="pill bad">No matches yet</span>'}</div>

          <h3 class="card-title" style="margin:14px 0 6px">Missing Keywords</h3>
          <div>${missing.map(k=>`<span class='pill bad'>${k}</span>`).join('') || '<span class="pill good">No gaps detected</span>'}</div>

          <h3 class="card-title" style="margin:14px 0 6px">Readability & Tone</h3>
          <p class="helper" style="margin:0 0 8px">
            ${gradeReadability(result.breakdown.readability)}. Bullets: <b>${result.profDetails.bullets}</b>,
            metrics used: <b>${result.profDetails.numbers}</b>, passive uses: <b>${result.profDetails.passive}</b>.
          </p>

          <h3 class="card-title" style="margin:14px 0 6px">Top Fixes</h3>
          <ul class="list-tight">${fixes}</ul>

          ${relatedHTML}           <!-- NEW: LinkedIn/Indeed searches -->
          ${verifiedHTML}          <!-- Optional: manual exact postings -->
        </div>`;

      wireToolbar();
      renderJobsGrid();
    }

    /* ===== Upload handling ===== */
    const fileInput = document.getElementById('resumeFile');
    const fileLabel = document.getElementById('fileLabel');
    const dropzone  = document.getElementById('dropzone');
    const scanSpinner = document.getElementById('scanSpinner');
    const scanText = document.getElementById('scanText');
    document.getElementById('btnPick').addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', e => { if (e.target.files?.[0]) handleResumeFile(e.target.files[0]); });
    ['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.remove('drag'); }));
    dropzone.addEventListener('drop', e=>{ const f = e.dataTransfer?.files?.[0]; if (f) handleResumeFile(f); });

    function setScanStatus(msg, spinning=false){
      const led = document.getElementById('statusLed');
      const spin = document.getElementById('scanSpinner');
      const txt  = document.getElementById('scanText');
      const m = String(msg||'').toLowerCase();
      led.classList.remove('ready','scanning','done','error');
      if (spinning){ led.classList.add('scanning'); spin.classList.add('show'); }
      else { spin.classList.remove('show'); if (/(error|unsupported|fail)/.test(m)) led.classList.add('error'); else if (/(extracted|success|done|✓|scored)/.test(m)) led.classList.add('done'); else led.classList.add('ready'); }
      txt.textContent = msg;
    }

    async function handleResumeFile(file){
      fileLabel.textContent = file.name;
      setScanStatus('Scanning...', true);
      try{
        const ext = file.name.split('.').pop().toLowerCase();
        let text = '';
        if (ext === 'pdf'){ text = await extractTextFromPDF(file); }
        else if (ext === 'docx'){ text = await extractTextFromDOCX(file); }
        else if (ext === 'txt'){ text = await file.text(); }
        else if (ext === 'rtf'){
          const raw = await file.text();
          text = raw.replace(/\\'[0-9a-fA-F]{2}/g,' ').replace(/\\[a-z]+\d*/g,' ').replace(/[{}]/g,' ').replace(/\\par/g,'\n');
        } else { setScanStatus('Unsupported file type. Use PDF, DOCX, or TXT.', false); return; }
        text = (text||'').trim();
        if (text.length < 20){
          setScanStatus('Could not extract much text — is it a scanned image PDF?', false);
          document.getElementById('resume').value = text; return;
        }
        document.getElementById('resume').value = text;
        setScanStatus('Text extracted ✓', false);
        analyze();
      } catch(err){
        console.error(err);
        setScanStatus('Error reading file. Try another format.', false);
      }
    }

    /* PDF.js */
    async function extractTextFromPDF(file){
      if (!window.pdfjsLib) throw new Error('PDF.js not loaded');
      const buf = await file.arrayBuffer();
      const loadingTask = pdfjsLib.getDocument({data: buf});
      const pdf = await loadingTask.promise;
      let fullText = '';
      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(it => ('str' in it ? it.str : it?.toString()) || '');
        fullText += strings.join(' ') + '\n';
      }
      return fullText.replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n');
    }

    /* Mammoth DOCX */
    async function extractTextFromDOCX(file){
      if (!window.mammoth) throw new Error('Mammoth not loaded');
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({arrayBuffer});
      return (result.value || '').replace(/\r/g,'').trim();
    }

    /* ===== Paywall & misc ===== */
    function openPaywall(n=1){ window.__desiredCredits = n; document.getElementById('paywall').classList.add('open'); }
    function closePaywall(){ document.getElementById('paywall').classList.remove('open'); }
    async function startCheckout(n=1){ addCredits(n); closePaywall(); alert(`Added ${n} scan${n>1?'s':''}. Swap this with Stripe for production.`); }
    function addCredits(n){ writeMeter({creditAdd:n}); }
    function clearAll(){
      document.getElementById('resume').value='';
      document.getElementById('jd').value='';
      document.getElementById('keywords').value='';
      document.getElementById('results').innerHTML = `
        <div style="text-align:center;color:var(--muted)">
          <div style="width:44px;height:44px;border-radius:9999px;margin:8px auto;background:linear-gradient(135deg,#60a5fa,#4f46e5)"></div>
          <h3 style="margin:6px 0 4px;color:var(--text)">Ready to score your resume</h3>
          <div class="helper">Paste your resume and click <b>Analyze</b>.</div>
        </div>`;
      fileInput.value = '';
      fileLabel.textContent = 'Choose PDF, DOCX, or TXT';
      setScanStatus('Ready', false);
    }

    updateMeterUI();
    updatePricingUI();
    setScanStatus('Ready', false);
  </script>
</body>
</html>
